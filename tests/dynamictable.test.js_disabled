// tests/dynamictable.test.js

const { spawn } = require('child_process'); // Required to spawn a test instance of the server
const request = require('supertest'); // Used to send http requests to the spawned instance
const path = require('path'); // Allow accessing files relative to the current directory

// Access parameters in the config.ini file
require('dotenv').config({ path: path.resolve(__dirname, '../config.ini') });
const serverPort = process.env.SERVER_PORT;

let serverProcess;

async function startServer() {
	const serverPath = path.resolve(__dirname, '../server.js');

	// Spawn the process
	serverProcess = spawn('node', [serverPath]);

	// Use a promise to wait for the server to start
	await new Promise((resolve) => {
		serverProcess.stdout.on('data', (data) => {
			console.log(`Process Output: ${data}`);
			if (data.includes('Now listening on port')) { setTimeout(resolve, 500); } // Wait 0.5s to ensure proper startup
		});
	});

	serverProcess.stderr.on('data', (data) => {
		console.error(`Process Error: ${data}`);
	});
}

async function stopServer() {
	serverProcess.kill('SIGTERM');
	await new Promise((resolve) => {
		serverProcess.on('exit', () => {
			resolve();
		});
	});
}

describe('Test Suite - Dynamic Table - POST', () => {
	beforeAll(startServer);
	
	const makePostRequest = async (endpoint, payload) => {
		return await request(`http://127.0.0.1:${serverPort}`).post(endpoint).send(payload);
	};
    const executeTest = async (description, endpoint, payload, expectation) => {
        test(description, async () => {
            const response = await makePostRequest(endpoint, payload);
			if (expectation) { expect(response.body.success).toBeTruthy(); }
			 else if (!expectation) { expect(response.body.success).toBeFalsy(); }
            console.log(`${description} response:`, response.body);
        });
    };

	const testCases = [
		{ description: "Test 1: List tables", 	    endpoint: "/cmd", 		expectation: true,	payload: { username: "test_admin", password: "test_pass", content: "tables" } },
		{ description: "Test 2: Create table", 	    endpoint: "/create", 	expectation: true,	payload: {
            "username": "test_admin",
            "password": "test_pass",
            "tablename": "new_table",
            "content": [
              { "name": "id", "type": "INTEGER", "options": ["PRIMARY KEY"] },
              { "name": "text", "type": "VARCHAR(255)", "value": "test string" }
            ]
        } },
		{ description: "Test 4: Read full table", 	endpoint: "/read", 		expectation: true,	payload: {
            "username": "test_admin",
            "password": "test_pass",
            "tablename": "new_table"
        }},
		{ description: "Test 5: Read table row", 	endpoint: "/read", 		expectation: true,	payload: {
            "username": "test_admin",
            "password": "test_pass",
            "tablename": "new_table",
            "content": { "id": "0" }
        }},
		{ description: "Test 6: Update table", 	    endpoint: "/update", 	expectation: true,	payload: {
            "username": "test_admin",
            "password": "test_pass",
            "tablename": "new_table",
            "content": [
                { "name": "text", "value": "updated string" },
                { "name": "extra_column", "type": "VARCHAR(255)", "value": "extra data" }
            ]
        }},
		{ description: "Test 7: Delete table row",  endpoint: "/delete", 	expectation: true,	payload: {
            "username": "test_admin",
            "password": "test_pass",
            "tablename": "new_table",
            "content": { "id": "1" }
        }},
		{ description: "Test 7: Delete full table", endpoint: "/delete", 	expectation: true,	payload: {
            "username": "test_admin",
            "password": "test_pass",
            "tablename": "new_table"
        }},
		{ description: "Test 8: Restore table", 	endpoint: "/restore",	expectation: true,	payload: {
            "username": "test_admin",
            "password": "test_pass",
            "tablename": "new_table"
        }},
		{ description: "Test 9: Drop table", 	    endpoint: "/drop", 		expectation: true,	payload: {
            "username": "test_admin",
            "password": "test_pass",
            "tablename": "new_table"
        }},
	];

	testCases.forEach(({ description, endpoint, payload, expectation }) => {
			executeTest(description, endpoint, payload, expectation);
		});

    afterAll(stopServer);
});